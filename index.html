import React, { useState } from 'react';
import { Upload, FileText, Download, Loader2, ArrowRight, Trash2 } from 'lucide-react';

const API_URL = 'https://pdftool.onrender.com/api'; // Replace with your actual Render URL

const AdvancedFileConverter = () => {
  const [activeTab, setActiveTab] = useState('convert');
  const [files, setFiles] = useState([]);
  const [processing, setProcessing] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState('');

  // Convert tab states
  const [fromFormat, setFromFormat] = useState('');
  const [toFormat, setToFormat] = useState('pdf');

  // Split tab states
  const [splitOption, setSplitOption] = useState('pages');
  const [pageRanges, setPageRanges] = useState('1-3, 5, 7-10');
  const [numParts, setNumParts] = useState('3');

  // Merge tab state
  const [mergeOrder, setMergeOrder] = useState([]);

  // Compress tab state
  const [compressionLevel, setCompressionLevel] = useState('medium');

  // Security tab states
  const [password, setPassword] = useState('');
  const [securityAction, setSecurityAction] = useState('watermark');
  const [watermarkText, setWatermarkText] = useState('CONFIDENTIAL');

  // Image operations state
  const [imageOperation, setImageOperation] = useState('rotate');
  const [rotationAngle, setRotationAngle] = useState('90');
  const [resizeWidth, setResizeWidth] = useState('800');
  const [resizeHeight, setResizeHeight] = useState('600');

  const supportedFormats = {
    document: ['pdf', 'docx', 'doc', 'txt', 'rtf', 'odt'],
    image: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'],
    spreadsheet: ['xlsx', 'xls', 'csv'],
    presentation: ['pptx', 'ppt']
  };

  const allFormats = Object.values(supportedFormats).flat();

  const tabs = [
    { id: 'convert', name: 'Convert', icon: 'ðŸ”„' },
    { id: 'merge', name: 'Merge', icon: 'ðŸ“‘' },
    { id: 'split', name: 'Split', icon: 'âœ‚ï¸' },
    { id: 'compress', name: 'Compress', icon: 'ðŸ“¦' },
    { id: 'security', name: 'Security', icon: 'ðŸ”’' },
    { id: 'image', name: 'Image Edit', icon: 'ðŸ–¼ï¸' }
  ];

  const handleFileUpload = (e) => {
    const uploadedFiles = Array.from(e.target.files);
    if (activeTab === 'merge') {
      setFiles([...files, ...uploadedFiles]);
      setMergeOrder([...mergeOrder, ...uploadedFiles.map((_, i) => files.length + i)]);
    } else {
      setFiles(uploadedFiles);
      if (uploadedFiles.length > 0) {
        const ext = uploadedFiles[0].name.split('.').pop().toLowerCase();
        setFromFormat(ext);
      }
    }
    setError('');
    setResult(null);
  };

  const removeFile = (index) => {
    const newFiles = files.filter((_, i) => i !== index);
    setFiles(newFiles);
    setMergeOrder(mergeOrder.filter(i => i !== index).map(i => i > index ? i - 1 : i));
  };

  const moveFile = (index, direction) => {
    const newOrder = [...mergeOrder];
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex >= 0 && newIndex < newOrder.length) {
      [newOrder[index], newOrder[newIndex]] = [newOrder[newIndex], newOrder[index]];
      setMergeOrder(newOrder);
    }
  };

  const handleProcess = async () => {
    if (files.length === 0) {
      setError('Please upload at least one file');
      return;
    }

    setProcessing(true);
    setError('');

    try {
      const formData = new FormData();
      
      let endpoint = '';
      
      switch(activeTab) {
        case 'convert':
          formData.append('file', files[0]);
          formData.append('toFormat', toFormat);
          endpoint = `${API_URL}/convert`;
          break;
          
        case 'merge':
          files.forEach((file, index) => {
            formData.append('files', file);
          });
          endpoint = `${API_URL}/merge`;
          break;
          
        case 'split':
          formData.append('file', files[0]);
          formData.append('splitOption', splitOption);
          formData.append('pageRanges', pageRanges);
          formData.append('numParts', numParts);
          endpoint = `${API_URL}/split`;
          break;
          
        case 'compress':
          formData.append('file', files[0]);
          formData.append('compressionLevel', compressionLevel);
          endpoint = `${API_URL}/compress`;
          break;
          
        case 'security':
          formData.append('file', files[0]);
          formData.append('securityAction', securityAction);
          formData.append('password', password);
          formData.append('watermarkText', watermarkText);
          endpoint = `${API_URL}/security`;
          break;
          
        case 'image':
          formData.append('file', files[0]);
          formData.append('imageOperation', imageOperation);
          formData.append('rotationAngle', rotationAngle);
          formData.append('resizeWidth', resizeWidth);
          formData.append('resizeHeight', resizeHeight);
          endpoint = `${API_URL}/image`;
          break;
      }

      const response = await fetch(endpoint, {
        method: 'POST',
        body: formData,
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Processing failed');
      }

      setResult({
        ...data,
        type: activeTab === 'split' ? 'multiple' : 'single'
      });
      
    } catch (err) {
      setError(err.message || 'An error occurred during processing');
    } finally {
      setProcessing(false);
    }
  };

  const handleDownload = () => {
    if (result && result.downloadUrl) {
      // Change API_URL to your actual backend URL
      const downloadLink = result.downloadUrl.startsWith('http') 
        ? result.downloadUrl 
        : `http://localhost:5000${result.downloadUrl}`;
      
      window.open(downloadLink, '_blank');
    }
  };

  const handleReset = () => {
    setFiles([]);
    setResult(null);
    setError('');
    setMergeOrder([]);
  };

  const renderConvertTab = () => (
    <div className="space-y-6">
      <div className="flex items-center justify-center gap-6">
        <div className="flex-1">
          <label className="block text-sm font-semibold text-gray-700 mb-2">From</label>
          <select
            value={fromFormat}
            onChange={(e) => setFromFormat(e.target.value)}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none bg-white uppercase font-medium"
          >
            <option value="">Auto-detect</option>
            {allFormats.map(format => (
              <option key={format} value={format}>{format}</option>
            ))}
          </select>
        </div>
        <div className="pt-8">
          <ArrowRight className="w-6 h-6 text-indigo-500" />
        </div>
        <div className="flex-1">
          <label className="block text-sm font-semibold text-gray-700 mb-2">To</label>
          <select
            value={toFormat}
            onChange={(e) => setToFormat(e.target.value)}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none bg-white uppercase font-medium"
          >
            {allFormats.map(format => (
              <option key={format} value={format}>{format}</option>
            ))}
          </select>
        </div>
      </div>
    </div>
  );

  const renderMergeTab = () => (
    <div className="space-y-4">
      <p className="text-sm text-gray-600">Upload multiple PDF files to merge them into one</p>
      {files.length > 0 && (
        <div className="space-y-2">
          <label className="block text-sm font-semibold text-gray-700">File Order</label>
          {mergeOrder.map((fileIndex, orderIndex) => (
            <div key={orderIndex} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <span className="text-sm font-semibold text-gray-500 w-8">{orderIndex + 1}.</span>
              <FileText className="w-5 h-5 text-indigo-500" />
              <span className="flex-1 text-sm text-gray-700 truncate">{files[fileIndex]?.name}</span>
              <div className="flex gap-2">
                <button
                  onClick={() => moveFile(orderIndex, 'up')}
                  disabled={orderIndex === 0}
                  className="px-3 py-1 text-sm hover:bg-gray-200 rounded disabled:opacity-30 font-semibold"
                >
                  â†‘
                </button>
                <button
                  onClick={() => moveFile(orderIndex, 'down')}
                  disabled={orderIndex === mergeOrder.length - 1}
                  className="px-3 py-1 text-sm hover:bg-gray-200 rounded disabled:opacity-30 font-semibold"
                >
                  â†“
                </button>
                <button
                  onClick={() => removeFile(fileIndex)}
                  className="p-1 hover:bg-red-100 rounded text-red-600"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );

  const renderSplitTab = () => (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-semibold text-gray-700 mb-2">Split Method</label>
        <select
          value={splitOption}
          onChange={(e) => setSplitOption(e.target.value)}
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none bg-white"
        >
          <option value="pages">By Page Range</option>
          <option value="size">Equal Parts</option>
        </select>
      </div>
      {splitOption === 'pages' && (
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2">Page Ranges</label>
          <input
            type="text"
            value={pageRanges}
            onChange={(e) => setPageRanges(e.target.value)}
            placeholder="e.g., 1-3, 5, 7-10"
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
          />
          <p className="text-xs text-gray-500 mt-2">Separate ranges with commas</p>
        </div>
      )}
      {splitOption === 'size' && (
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2">Number of Parts</label>
          <input
            type="number"
            min="2"
            value={numParts}
            onChange={(e) => setNumParts(e.target.value)}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
          />
        </div>
      )}
    </div>
  );

  const renderCompressTab = () => (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-semibold text-gray-700 mb-3">Compression Level</label>
        <div className="space-y-3">
          {['low', 'medium', 'high', 'extreme'].map(level => (
            <label key={level} className="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-500 transition-colors">
              <input
                type="radio"
                name="compression"
                value={level}
                checked={compressionLevel === level}
                onChange={(e) => setCompressionLevel(e.target.value)}
                className="w-4 h-4 text-indigo-600"
              />
              <div className="flex-1">
                <div className="font-semibold text-gray-700 capitalize">{level}</div>
                <div className="text-xs text-gray-500">
                  {level === 'low' && 'Best quality, larger file size'}
                  {level === 'medium' && 'Balanced quality and size'}
                  {level === 'high' && 'Smaller size, slight quality loss'}
                  {level === 'extreme' && 'Maximum compression'}
                </div>
              </div>
            </label>
          ))}
        </div>
      </div>
    </div>
  );

  const renderSecurityTab = () => (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-semibold text-gray-700 mb-2">Action</label>
        <select
          value={securityAction}
          onChange={(e) => setSecurityAction(e.target.value)}
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none bg-white"
        >
          <option value="watermark">Add Watermark</option>
          <option value="encrypt">Add Password Protection (Requires qpdf)</option>
        </select>
      </div>
      {securityAction === 'watermark' && (
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2">Watermark Text</label>
          <input
            type="text"
            value={watermarkText}
            onChange={(e) => setWatermarkText(e.target.value)}
            placeholder="Enter watermark text"
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
          />
        </div>
      )}
      {securityAction === 'encrypt' && (
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Enter password"
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
          />
        </div>
      )}
    </div>
  );

  const renderImageTab = () => (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-semibold text-gray-700 mb-2">Operation</label>
        <select
          value={imageOperation}
          onChange={(e) => setImageOperation(e.target.value)}
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none bg-white"
        >
          <option value="rotate">Rotate</option>
          <option value="resize">Resize</option>
          <option value="crop">Crop</option>
          <option value="filter">Grayscale Filter</option>
        </select>
      </div>
      {imageOperation === 'rotate' && (
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-2">Rotation Angle</label>
          <select
            value={rotationAngle}
            onChange={(e) => setRotationAngle(e.target.value)}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none bg-white"
          >
            <option value="90">90Â° Clockwise</option>
            <option value="180">180Â°</option>
            <option value="270">270Â° (90Â° Counter-clockwise)</option>
          </select>
        </div>
      )}
      {(imageOperation === 'resize' || imageOperation === 'crop') && (
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Width (px)</label>
            <input
              type="number"
              value={resizeWidth}
              onChange={(e) => setResizeWidth(e.target.value)}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
            />
          </div>
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Height (px)</label>
            <input
              type="number"
              value={resizeHeight}
              onChange={(e) => setResizeHeight(e.target.value)}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
            />
          </div>
        </div>
      )}
    </div>
  );

  const getTabContent = () => {
    switch(activeTab) {
      case 'convert': return renderConvertTab();
      case 'merge': return renderMergeTab();
      case 'split': return renderSplitTab();
      case 'compress': return renderCompressTab();
      case 'security': return renderSecurityTab();
      case 'image': return renderImageTab();
      default: return null;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 py-8 px-4">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <div className="flex items-center justify-center mb-4">
            <FileText className="w-12 h-12 text-purple-400" />
          </div>
          <h1 className="text-4xl font-bold text-white mb-3">
            Advanced File Processor
          </h1>
          <p className="text-purple-200 text-lg">
            Convert, Merge, Split, Compress & More
          </p>
        </div>

        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-2 mb-6">
          <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
            {tabs.map(tab => (
              <button
                key={tab.id}
                onClick={() => {
                  setActiveTab(tab.id);
                  handleReset();
                }}
                className={`flex flex-col items-center gap-2 p-4 rounded-xl transition-all ${
                  activeTab === tab.id
                    ? 'bg-purple-600 text-white shadow-lg scale-105'
                    : 'text-purple-200 hover:bg-white/10'
                }`}
              >
                <span className="text-2xl">{tab.icon}</span>
                <span className="text-xs font-semibold">{tab.name}</span>
              </button>
            ))}
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-2xl p-8">
          <div className="mb-6">
            <input
              type="file"
              onChange={handleFileUpload}
              className="hidden"
              id="file-upload"
              multiple={activeTab === 'merge'}
              accept={activeTab === 'image' ? 'image/*' : '*'}
            />
            <label
              htmlFor="file-upload"
              className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-purple-300 rounded-xl cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all"
            >
              <Upload className="w-10 h-10 text-purple-500 mb-2" />
              <span className="text-sm text-gray-600">
                {files.length > 0 ? `${files.length} file(s) selected` : 'Click to upload files'}
              </span>
              {activeTab === 'merge' && (
                <span className="text-xs text-gray-400 mt-1">You can select multiple files</span>
              )}
            </label>
          </div>

          {files.length > 0 && (
            <div className="mb-6">
              {getTabContent()}
            </div>
          )}

          {error && (
            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-red-600 text-sm">{error}</p>
            </div>
          )}

          {files.length > 0 && !result && (
            <button
              onClick={handleProcess}
              disabled={processing}
              className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg"
            >
              {processing ? (
                <>
                  <Loader2 className="w-5 h-5 animate-spin" />
                  Processing...
                </>
              ) : (
                `Process Files`
              )}
            </button>
          )}

          {result && (
            <div className="space-y-4">
              <div className="p-6 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="font-semibold text-green-800">{result.message}</h3>
                    {result.size && <p className="text-sm text-green-600">{result.size}</p>}
                  </div>
                </div>
                <button
                  onClick={handleDownload}
                  className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-all flex items-center justify-center gap-2"
                >
                  <Download className="w-5 h-5" />
                  Download {result.type === 'multiple' ? 'All Files' : 'File'}
                </button>
              </div>
              <button
                onClick={handleReset}
                className="w-full border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-all"
              >
                Process Another File
              </button>
            </div>
          )}
        </div>

        <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 text-white">
            <h4 className="font-semibold mb-2">ðŸ”’ Secure Processing</h4>
            <p className="text-sm text-purple-200">All files processed on your server</p>
          </div>
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 text-white">
            <h4 className="font-semibold mb-2">âš¡ Real Processing</h4>
            <p className="text-sm text-purple-200">Actual file conversion with backend</p>
          </div>
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 text-white">
            <h4 className="font-semibold mb-2">ðŸ“¦ Multiple Formats</h4>
            <p className="text-sm text-purple-200">Support for images, PDFs, and documents</p>
          </div>
        </div>

        <div className="mt-6 text-center text-sm text-purple-200">
          <p>âœ… Fully Functional - Backend Required</p>
        </div>
      </div>
    </div>
  );
};


export default AdvancedFileConverter;
